<!DOCTYPE html>
<html>

<head>
  <title>ASCII Art Maker</title>
  <style>
    body {
      font-size: 2rem;
      background-color: black;
      font-family: monospace;
      line-height: 2rem;
      color: #777;
    }

    #bg {
      display: grid;
    }

    .layer {
      grid-column: 1;
      grid-row: 1;
      display: grid;
      width: 10ch;
      grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
      user-select: none;
      > pre {
        outline: 1px solid #111;
      }
    }

    .activeLayer {
      color: gold;
    }

    *,
    *::before,
    *::after {
      margin: 0;
    }

    /*
    .selectedPixel {
      outline: 1px gold solid;
    }
    */

    .pixel {
      min-width: 1ch max-width: 1ch
    }
  </style>

  <script>


    const focusOnClick = (event) => {
      event.srcElement.contentEditable = true
      const selection = window.getSelection();
      selection.removeAllRanges();
      const range = document.createRange()
      range.selectNodeContents(event.srcElement)
      selection.addRange(range)
    }

    const s = {
      bg: null,
      layers: [],
      cols: 10,
      rows: 10,
      current: {l: null, r: null, c: null},
      layerEls: [],
    }

    const addLayer = () => {
      console.log("adding layer")
      // pull layer number before adding to match 0 index
      s.current.l = s.layers.length;
      const newLayer = document.createElement("div")
      newLayer.id = `layer_${s.current.l}`
      newLayer.classList.add("layer")
      newLayer.classList.add("activeLayer")
      s.layerEls.push(newLayer);
      const lHolder = []
      for (let c = 0; c < s.cols; c += 1) {
        const cHolder = []
        for (let r = 0; r < s.rows; r += 1) {
          const newPixel = document.createElement("pre")
          newPixel.classList.add("pixel")
          newPixel.dataset.l = s.current.l
          newPixel.dataset.r = r
          newPixel.dataset.c = c
          newPixel.innerHTML = "&nbsp;"
          newPixel.addEventListener("click", selectPixelFromClick)
          newLayer.appendChild(newPixel)
          cHolder.push(newPixel)
        }
        lHolder.push(cHolder)
      }
      s.layers.push(lHolder)
      s.wrap.appendChild(newLayer)

      if (s.current.r === null) {
        s.current.r = 0
      }
      if (s.current.c === null) {
        s.current.c = 0
      }
      setStyles()
    }

    const setStyles = () => {
      for (let l = 0; l < s.layers.length; l += 1) {
        for (let c = 0; c < s.cols; c += 1) {
          for (let r = 0; r < s.rows; r += 1) {
            s.layers[l][c][r].classList.remove("selectedPixel")
          }
        }
        if (l == s.current.l) {
          s.layerEls[l].classList.add("activeLayer")
        } else {
          s.layerEls[l].classList.remove("activeLayer")
        }
      }
    }



    const selectPixelFromClick = (event) => {
      setStyles()
      event.srcElement.contentEditable = true
      const selection = window.getSelection();
      selection.removeAllRanges();
      const range = document.createRange()
      range.selectNodeContents(event.srcElement)
      selection.addRange(range)
      event.srcElement.focus({focusVisible: false})
      s.current.l = event.srcElement.dataset.l
      s.current.r = event.srcElement.dataset.r
      s.current.c = event.srcElement.dataset.c
      event.srcElement.classList.add("selectedPixel")
      console.log(s.current)

    }


    const init = () => {
      s.wrap = document.getElementById("bg")
      addLayerButton.addEventListener("click", addLayer)
      addLayer()
    }
    document.addEventListener("DOMContentLoaded", init)

  </script>

</head>

<body>
  <div class="wrapper">
    <button id="addLayerButton">Add Layer</button>
    <div id="bg"></div>
  </div>
</body>

</html>
