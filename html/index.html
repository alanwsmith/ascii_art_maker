<!DOCTYPE html>
<html>

<head>
  <title>ASCII Art Maker</title>
  <style>
    body {
      font-size: 2rem;
      background-color: black;
      font-family: monospace;
      line-height: 2rem;
      color: #777;
      caret-color: transparent;
    }

    #bg {
      display: grid;
    }

    .layer {
      grid-column: 1;
      grid-row: 1;
      display: grid;
      width: 10ch;
      grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
      user-select: none;
    }

    .activeLayer {
      color: gold;
    }

    *,
    *::before,
    *::after {
      margin: 0;
    }

    .pixel {
      min-width: 1.1ch;
      max-width: 1.1ch;
      min-height: 1.1em;
    }

    .inactivePixel {
      outline: 1px solid #111;
    }

    .activePixel {
      outline: 1px solid blue;
    }

    #chars {
      display: flex;
      flex-wrap: wrap;

      >.char {
        padding: 0.3rem;
        outline: 1px solid green;
        width: 1.4em;
        text-align: center;
      }
    }

    .wrapper {
      width: 800px;
      border: 1px solid red;
    }
  </style>

  <script>

    const s = {
      bg: null,
      layers: [],
      cols: 10,
      rows: 10,
      current: {l: 0, r: 0, c: 0},
      layerEls: [],
      showGrid: 1,
      wasdNav: 1,
    }

    const addLayer = () => {
      console.log("adding layer")
      // pull layer number before adding to match 0 index
      s.current.l = s.layers.length;
      const newLayer = document.createElement("div")
      newLayer.id = `layer_${s.current.l}`
      newLayer.classList.add("layer")
      newLayer.classList.add("activeLayer")
      s.layerEls.push(newLayer);
      const lHolder = []
      for (let c = 0; c < s.cols; c += 1) {
        const cHolder = []
        for (let r = 0; r < s.rows; r += 1) {
          const newPixel = document.createElement("pre")
          newPixel.classList.add("pixel")
          newPixel.dataset.l = s.current.l
          newPixel.dataset.r = r
          newPixel.dataset.c = c
          newPixel.innerHTML = ""
          newPixel.addEventListener("click", selectPixelFromClick)
          newPixel.addEventListener("keydown", reactToKeys)
          newLayer.appendChild(newPixel)
          cHolder.push(newPixel)
        }
        lHolder.push(cHolder)
      }
      s.layers.push(lHolder)
      renderLayers()
      // s.wrap.appendChild(newLayer)
      if (s.current.r === null) {
        s.current.r = 0
      }
      if (s.current.c === null) {
        s.current.c = 0
      }
      currentLayerDisplay.innerHTML = `Current Layer: ${s.current.l + 1}`
      setStyles()
    }

    const setStyles = () => {
      for (let l = 0; l < s.layers.length; l += 1) {
        for (let c = 0; c < s.cols; c += 1) {
          for (let r = 0; r < s.rows; r += 1) {
            s.layers[l][c][r].contentEditable = false
            s.layers[l][c][r].classList.remove("activePixel")
            if (s.showGrid == 1) {
              s.layers[l][c][r].classList.add("inactivePixel")
            }
            else {
              s.layers[l][c][r].classList.remove("inactivePixel")
            }
          }
        }
        if (l == s.current.l) {
          s.layerEls[l].classList.add("activeLayer")
        } else {
          s.layerEls[l].classList.remove("activeLayer")
        }
      }
    }

    const selectPixelFromClick = (event) => {
      setStyles()
      event.srcElement.contentEditable = true
      const selection = window.getSelection();
      selection.removeAllRanges();
      const range = document.createRange()
      range.selectNodeContents(event.srcElement)
      selection.addRange(range)
      event.srcElement.focus({focusVisible: false})
      s.current.l = parseInt(event.srcElement.dataset.l)
      s.current.r = parseInt(event.srcElement.dataset.r)
      s.current.c = parseInt(event.srcElement.dataset.c)
      if (s.showGrid == 1) {
        event.srcElement.classList.add("activePixel")
      }
      console.log(s.current)
    }

    const moveForwardLayer = () => {
      if (s.current.l == s.layers.length - 1) {
        s.current.l = 0
      } else {
        s.current.l += 1
      }
      currentLayerDisplay.innerHTML = `Current Layer: ${s.current.l + 1}`
      setStyles()
      selectPixelFromClick({
        srcElement: s.layers[s.current.l][s.current.c][s.current.r]
      })
      renderLayers()
    }

    const moveBackLayer = () => {
      if (s.current.l == 0) {
        s.current.l = s.layers.length - 1
      } else {
        s.current.l -= 1
      }
      currentLayerDisplay.innerHTML = `Current Layer: ${s.current.l + 1}`
      setStyles()
      selectPixelFromClick({
        srcElement: s.layers[s.current.l][s.current.c][s.current.r]
      })
      renderLayers()
    }

    const reactToKeys = (event) => {
      console.log(event)
      if (event.code === "ArrowLeft") {
        if (s.current.r != 0) {
          s.current.r = s.current.r - 1
        }
      }
      else if (event.code === "ArrowRight") {
        if (s.current.r < s.layers[0][0].length - 1) {
          s.current.r += 1
        }
      }
      else if (event.code === "ArrowUp") {
        if (s.current.c != 0) {
          s.current.c -= 1
        }
      }
      else if (event.code === "ArrowDown") {
        if (s.current.c < s.layers[0].length - 1) {
          s.current.c += 1
        }
      }
      if (event.code === "KeyA" && s.wasdNav === 1) {
        event.preventDefault()
        if (s.current.r != 0) {
          s.current.r = s.current.r - 1
        }
      }
      else if (event.code === "KeyD" && s.wasdNav === 1) {
        event.preventDefault()
        if (s.current.r < s.layers[0][0].length - 1) {
          s.current.r += 1
        }
      }
      else if (event.code === "KeyW" && s.wasdNav === 1) {
        event.preventDefault()
        if (s.current.c != 0) {
          s.current.c -= 1
        }
      }
      else if (event.code === "KeyS" && s.wasdNav === 1) {
        event.preventDefault()
        if (s.current.c < s.layers[0].length - 1) {
          s.current.c += 1
        }
      }
      else {

      }
      selectPixelFromClick({
        srcElement: s.layers[s.current.l][s.current.c][s.current.r]
      })

    }


    // move the active layer to the top so
    // contentEditable works properly
    const renderLayers = () => {
      while (bg.children.length > 0) {
        bg.children[0].remove()
      }
      s.layerEls.forEach((layer, layerIndex) => {
        if (layerIndex !== s.current.l) {
          bg.appendChild(layer)
        }
      })
      bg.appendChild(s.layerEls[s.current.l])
    }

    const toggleGrid = () => {
      if (s.showGrid == 1) {
        s.showGrid = 0
        toggleGridButton.innerHTML = "Show Grid"
      } else {
        s.showGrid = 1
        toggleGridButton.innerHTML = "Hide Grid"
      }
      setStyles()
      selectPixelFromClick({
        srcElement: s.layers[s.current.l][s.current.c][s.current.r]
      })
    }

    const toggleWASD = () => {
      if (s.wasdNav == 1) {
        s.wasdNav = 0
        toggleWASDButton.innerHTML = "Turn WASD Nav On"
      } else {
        s.wasdNav = 1
        toggleWASDButton.innerHTML = "Turn WASD Nav Off"
      }
    }


    const addCharacter = (event) => {
      console.log(event.srcElement.innerHTML)
    }


    const init = () => {
      s.wrap = document.getElementById("bg")
      addLayerButton.addEventListener("click", addLayer)
      forwardLayerButton.addEventListener("click", moveForwardLayer)
      backLayerButton.addEventListener("click", moveBackLayer)
      toggleGridButton.addEventListener("click", toggleGrid)
      toggleWASDButton.addEventListener("click", toggleWASD)

      const chars = document.getElementsByClassName("char")
      for (c = 0; c < chars.length; c += 1) {
        chars[c].addEventListener("click", addCharacter)
      }

      addLayer()
      renderLayers()

      dt.innerHTML = new Date()

    }

    document.addEventListener("DOMContentLoaded", init)

  </script>

</head>

<body>

  <div id="dt"></div>
  <div class="wrapper">
    <button id="addLayerButton">Add Layer</button>
    <button id="backLayerButton">Down A Layer</button>
    <button id="forwardLayerButton">Up A Layer</button>
    <button id="toggleGridButton">Hide Grid</button>
    <button id="toggleWASDButton">Turn WASD Nav Off</button>
    <div id="currentLayerDisplay">Current Layer: 1</div>
    <div id="bg"></div>

    <div id="chars">
      <pre class="char">&#x00C1;</pre>
      <pre class="char">&#x00E1;</pre>
      <pre class="char">&#x0103;</pre>
      <pre class="char">&#x01CE;</pre>
      <pre class="char">&#x00C2;</pre>
      <pre class="char">&#x00E2;</pre>
      <pre class="char">&#x00C4;</pre>
      <pre class="char">&#x00E4;</pre>
      <pre class="char">&#x0227;</pre>
      <pre class="char">&#x1EA1;</pre>
      <pre class="char">&#x0201;</pre>
      <pre class="char">&#x00C0;</pre>
      <pre class="char">&#x00E0;</pre>
      <pre class="char">&#x1EA3;</pre>
      <pre class="char">&#x0203;</pre>
      <pre class="char">&#x0101;</pre>
      <pre class="char">&#x0105;</pre>
      <pre class="char">&#x1E9A;</pre>
      <pre class="char">&#x00C5;</pre>
      <pre class="char">&#x00E5;</pre>
      <pre class="char">&#x1E01;</pre>
      <pre class="char">&#x023A;</pre>
      <pre class="char">&#x00C3;</pre>
      <pre class="char">&#x00E3;</pre>
      <pre class="char">&#x0363;</pre>
      <pre class="char">&#x1D00;</pre>
      <pre class="char">&#x0251;</pre>
      <pre class="char">&#x0250;</pre>
      <pre class="char">&#x055F;</pre>
      <pre class="char">&#x070F;</pre>
      <pre class="char">&#x0970;</pre>
      <pre class="char">&#x3371;</pre>
    </div>


  </div>
</body>

</html>
